<!DOCTYPE html>
<html lang="es">

<head>
    <title>Lectura Viva - Acceso</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* Estilo para asegurar que el contenido se centre en la página */
        
        .full-height {
            min-height: 100vh;
        }
        /* Estilo para ocultar el formulario de registro al inicio */
        
        #registerForm {
            display: none;
        }
    </style>
</head>

<body class="bg-dark text-white">

    <nav class="navbar navbar-expand-lg navbar-dark bg-secondary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold fs-4" href="index.html">Lectura Viva</a>
        </div>
    </nav>

    <div class="container d-flex justify-content-center align-items-center full-height pt-5">

        <div class="card bg-secondary text-white shadow p-4" style="width: 100%; max-width: 450px;">

            <div class="card-header text-center border-0 bg-secondary">
                <h3 id="formTitle">Iniciar Sesión</h3>
                <div class="btn-group w-100 mt-3" role="group">
                    <button id="showLoginBtn" type="button" class="btn btn-primary active" onclick="toggleForm('login')">Iniciar Sesión</button>
                    <button id="showRegisterBtn" type="button" class="btn btn-outline-primary" onclick="toggleForm('register')">Registrarme</button>
                </div>
            </div>

            <div class="card-body">

                <form id="loginForm" onsubmit="iniciarSesion(event)">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="ejemplo@correo.cl" required>
                    </div>
                    <div class="mb-4">
                        <label for="loginPass" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="loginPass" placeholder="Ingrese su contraseña" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Acceder</button>
                </form>

                <form id="registerForm" onsubmit="registrarse(event)">
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="registerEmail" placeholder="ejemplo@correo.cl" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPass" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="registerPass" placeholder="Cree una contraseña (mín. 6 caracteres)" required minlength="6">
                    </div>
                    <div class="mb-4">
                        <label for="confirmPass" class="form-label">Confirmar Contraseña</label>
                        <input type="password" class="form-control" id="confirmPass" placeholder="Repita la contraseña" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Crear Cuenta</button>
                </form>

            </div>
        </div>

    </div>

    <script>
        // *** IMPORTANTE: Cambia esta URL si tu backend se ejecuta en otro puerto o dominio ***
        const API_URL = 'http://127.0.0.1:8000';

        // Función para alternar entre Login y Registro
        function toggleForm(mode) {
            const login = document.getElementById('loginForm');
            const register = document.getElementById('registerForm');
            const title = document.getElementById('formTitle');
            const btnLogin = document.getElementById('showLoginBtn');
            const btnRegister = document.getElementById('showRegisterBtn');

            if (mode === 'login') {
                login.style.display = 'block';
                register.style.display = 'none';
                title.textContent = 'Iniciar Sesión';
                btnLogin.classList.add('active');
                btnLogin.classList.remove('btn-outline-primary');
                btnRegister.classList.remove('active');
                btnRegister.classList.add('btn-outline-primary');
            } else {
                login.style.display = 'none';
                register.style.display = 'block';
                title.textContent = 'Registrarme';
                btnRegister.classList.add('active');
                btnRegister.classList.remove('btn-outline-primary');
                btnLogin.classList.remove('active');
                btnLogin.classList.add('btn-outline-primary');
            }
        }

        // -----------------------------------------------------
        // Lógica de Inicio de Sesión (Integración con Backend)
        // -----------------------------------------------------
        async function iniciarSesion(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            // Mutación GraphQL
            const LOGIN_MUTATION = `
                mutation Login($email: String!, $password: String!) {
                    login(email: $email, password: $password) {
                        token 
                    }
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: LOGIN_MUTATION,
                        variables: {
                            email: email,
                            password: pass
                        }
                    }),
                });

                const result = await response.json();

                if (result.errors) {
                    // Muestra el mensaje de error de GraphQL (ej: credenciales incorrectas)
                    alert("Error al iniciar sesión: " + result.errors[0].message);
                } else if (result.data && result.data.login && result.data.login.token) {
                    const token = result.data.login.token;

                    // Almacena el token JWT
                    localStorage.setItem('authToken', token);
                    alert("¡Inicio de sesión exitoso!");

                    // Redirige al usuario
                    window.location.href = "Inicio.html";

                } else {
                    alert("Error desconocido en la respuesta del servidor.");
                }

            } catch (error) {
                console.error("Error de conexión con el servidor:", error);
                alert("Error de red: No se pudo conectar con el servidor de Lectura Viva.");
            }
        }

        // -----------------------------------------------------
        // Lógica de Registro (Integración con Backend)
        // -----------------------------------------------------
        async function registrarse(event) {
            event.preventDefault();
            const email = document.getElementById("registerEmail").value;
            const pass = document.getElementById("registerPass").value;
            const confirmPass = document.getElementById("confirmPass").value;

            // 1. Validación de Contraseñas
            if (pass !== confirmPass) {
                alert("Las contraseñas no coinciden.");
                return;
            }

            // Mutación GraphQL (asumo que tu backend usa una mutación llamada 'register')
            const REGISTER_MUTATION = `
                mutation Register($email: String!, $password: String!) {
                    register(email: $email, password: $password) {
                        id
                        email
                    }
                }
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: REGISTER_MUTATION,
                        variables: {
                            email: email,
                            password: pass
                        }
                    }),
                });

                const result = await response.json();

                if (result.errors) {
                    // Muestra el mensaje de error de GraphQL (ej: 'El correo ya está en uso')
                    alert("Error al registrar: " + result.errors[0].message);
                } else if (result.data && result.data.register && result.data.register.id) {

                    alert(`¡Registro exitoso para ${email}! Ahora puedes iniciar sesión.`);

                    // Si es exitoso, cambia a la vista de login
                    toggleForm('login');

                } else {
                    alert("Error desconocido al registrar la cuenta.");
                }

            } catch (error) {
                console.error("Error de conexión con el servidor:", error);
                alert("Error de red: No se pudo conectar con el servidor de Lectura Viva.");
            }
        }
    </script>
</body>

</html>